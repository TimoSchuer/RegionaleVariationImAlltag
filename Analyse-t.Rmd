---
title: "Analyse Lautposition von historischem /t/ im Auslaut"
output: html_notebook
---


Clusterverfahren in Funktion schreiben
```{r}
com_clust <- function(data,variables = c(1:ncol(data)),weight= 1){
adjmatrix <- 1- daisy(data[,variables], metric = c("gower"), weights = weight) # ungewichteter Vergleich, ausgenommen e0, e1, da nur ein auftreten überhaupt

x <- as.matrix(adjmatrix) #schreibt Aehnlichkeitsmatrix in ein R Objekt

g1 <- graph_from_adjacency_matrix(x, mode = c("lower"), weighted = TRUE, diag = FALSE, add.colnames = NULL, add.rownames = NA) #erstellt Graphfile aus unterer H??lfte der Aehnlichkeitsmatrix

cfg <- cluster_louvain(g1, weights = NULL) #sucht im Graphen nach Gruppen

#plot(cfg, g1, vertex.size=10, vertex.label.font=20, family="serif", edge.width=E(g1)$weight, sub= stringr::str_c("Modularity=",modularity(cfg))) #Zeichnet Graphen samt Gruppierungen

group <- as.factor(membership(cfg))
data$group <- group

return(list(data,
plot(cfg, g1, vertex.size=10, vertex.label.font=20, family="serif", edge.width=E(g1)$weight, sub= stringr::str_c("Modularity=",modularity(cfg)))))
}
```

Install the ExmaraldaR Beta Package
```{r}

library(devtools)
```
```{r}
install_github("TimoSchuer/ExmaraldaR", force = TRUE)

```
load all required packages

```{r}
library(ExmaraldaR)
library(igraph)
library(Matrix)
library(cluster)
library(dplyr)
library(tm)
library(koRpus)
library(koRpus.lang.de)
library(purrr)
library(ggplot2)
library(FactoMineR)
library(ca)
library(rms)
library(MASS)
library(reshape2)

```


Read Korpus, set Path of required Directorys/ files, set Path of treetagger
```{r}
pathDir <- "C:\\Users\\Admin\\sciebo\\Publikationen\\VndS Band\\Korpus\\Formatiert\\ohne schnelle Anschlüsse"
pathTagSet <- "C:\\Users\\Admin\\sciebo\\Publikationen\\VndS Band\\Korpus\\Formatiert\\2017_09_26_Annotation TagSet.xml"
PathTreeTag= "C:/TreeTagger/bin/tag-german.bat" 
set.kRp.env(TT.cmd= PathTreeTag, lang= "de")#Pfad des TreeTagges setzen
```
Read Korpus
Subsetting annotated events
```{r}
Corpus <- read_exb_dir(pathDir = pathDir, addMetaData = TRUE)
Corpus$Variable <- stringr::str_remove_all(Corpus$Variable,";")
Annotated <- filter(Corpus, !(is.na(Variable)))
Annotated <- Annotated [,-c(15:19)] # remove irrelevant Metadata
```

Lemmatize annotated events
```{r}
stringr::str_remove_all(Annotated$Text, "\\W") %>% 
  stringr::str_to_lower() ->token
  PoSLemma <- treetag(token,debug=TRUE, format= "obj")
Annotated <- cbind(Annotated, PoSLemma[,2:3])
Corpus <- left_join(Corpus, Annotated)
#test <- tidyr::unite(Corpus,Variable, Variable:Variante, sep=":")
```
Corpus und Annotated als CSV speichern für Reproduktion
```{r}
write.csv(Corpus, file= "Corpus.csv", sep = ";")
write.csv(Annotated, file= "Annotated.csv", sep = ";")
```
Split up Variable and variant
```{r}
Annotated <- tidyr::separate(Annotated,col= "Variable", into=c("Variable","Variante"), sep=":")
#Corpus <- tidyr::separate(Corpus,col= "Variable", into=c("Variable","Variante"), sep=":")
```
Belege für Lautposition von historisch t im Wortauslaut auswählen (V04)
```{r}
V4 <- filter(Annotated, Variable=="V04")
AnalyseV4 <- dplyr::select(V4, 3,6,11,14:28) 
for (k in 1:ncol(AnalyseV4)) {
  AnalyseV4[,k] <- as.factor(AnalyseV4[,k])
}
#Plot nach annotierten Kategorien
AnalyseV4 <- com_clust(AnalyseV4)
AnalyseV4 <- AnalyseV4[[1]]
```


Merge Tags by IP
```{r}
# Merge Tags
V4TagMerge <- V4
remove(k)
V4TagMerge$tag <-as.character(V4TagMerge$tag)
V4TagMerge$lemma <- as.character(V4TagMerge$lemma)
V4TagMerge <- fastDummies::dummy_columns(V4TagMerge, select_columns = c("lemma"))
for (k in nrow(V4TagMerge):2) {
  if((V4TagMerge[k,1]==V4TagMerge[k-1,1])){
    if(V4TagMerge$tag[k] != V4TagMerge$tag[k-1]){
    V4TagMerge[k-1,33:62] <- V4TagMerge[k-1,33:62]+V4TagMerge[k,33:62]
   # V4TagMerge$lemma[k-1] <- stringr::str_c(V4TagMerge$lemma[k-1],V4TagMerge$lemma[k], sep = ":")
    
    }
    V4TagMerge <- V4TagMerge[-k,]
  }else{
    next()
  }
  
}
V4TagMerge <- V4TagMerge[,33:62]
for (k in 1:ncol(V4TagMerge)) {
  for(l in 1:nrow(V4TagMerge)){
    if(V4TagMerge[l,k]==0){
      V4TagMerge[l,k] <- NA
    }
  }
}
#V4TagMerge$tag <-as.factor(V4TagMerge$tag)
#V4TagMerge$lemma <-as.factor(V4TagMerge$lemma)
#V4IpTag <- cbind(SortIpV4,V4TagMerge$tag,V4TagMerge$lemma)

```
Sort by IP
```{r}
SortIpNA <- sort_by_unit(exb=Corpus, drop = TRUE)
SortIpNaAbsolute <- sort_by_unit(Corpus, drop=TRUE, percentage=FALSE)
```

Plot Kookkurrenz über Situationen hinweg (mit Lemma und Wortart)
```{r}
SortIpV4 <- filter(SortIpNA, SortIpNA$`Variable:V04:tu`!=0|SortIpNA$`Variable:V04:tv`!=0)
SortIpV4 <- bind_cols(SortIpV4, V4TagMerge)
#SortIpOHNEMA3 <- filter(SortIpV4,File != " Ma3" )
#SortIpV4 <- select(SortIpV4, 1,16:40)
for (p in 1:ncol(SortIpNA)) {
  SortIpNA[,p] <- as.factor(SortIpNA[,p])
}
SortIpV4 <- com_clust(SortIpV4, variables = c(21:62))
SortIpV4 <- SortIpV4[[1]]
```

Cooccurrence Plot by Situation (mit Lemma und Wortart)
```{r}
#SortIpNA <- sort_by_unit(exb=Corpus, drop = TRUE)

files <- unique(SortIpV4$File)
for (k in 1:length(files)) {
  g <- filter(SortIpV4, SortIpV4$File==files[k])
    for (p in 1:ncol(g)) {
     g[,p] <- as.factor(g[,p])
    }
  name <- stringr::str_glue("SortIpV4",stringr::str_trim(files[k]))
  assign(name,g)
}
test <- SortIpV4Ma1[,21:75]
test <- mutate_all(test,as.numeric)
i <- which(colSums(test)!=0)
SortIpV4Ma1 <- com_clust(SortIpV4Ma1,variables = c(21:75))
SortIpV4Ma1 <- SortIpV4Ma1[[1]]
SortIpV4Ma2 <- com_clust(SortIpV4Ma2,variables = c(21:75))
SortIpV4Ma2 <- SortIpV4Ma2[[1]]
SortIpV4Ma4 <- com_clust(SortIpV4Ma4,variables = c(21:75))
SortIpV4Ma4 <- SortIpV4Ma4[[1]]
```
Cooccurrence Plot by Situation (ohne Lemma und Wortart)
```{r}
#SortIpNA <- sort_by_unit(exb=Corpus, drop = TRUE)
i <- SortIpV4Ma1[,21:41] %>% mutate_if(is.factor,as.numeric) %>% colSums(na.rm = TRUE)

SortIpV4Ma1 <- com_clust(SortIpV4Ma1,variables = c(21:37,40:41))
SortIpV4Ma1 <- SortIpV4Ma1[[1]]
SortIpV4Ma2 <- com_clust(SortIpV4Ma2,variables = c(21:41))
SortIpV4Ma2 <- SortIpV4Ma2[[1]]
SortIpV4Ma4 <- com_clust(SortIpV4Ma4,variables = c(21:41))
SortIpV4Ma4 <- SortIpV4Ma4[[1]]
```
Barplots by groups
```{r}
SortIpV4Ma1[,21:44] %>%  melt(id.vars= "group")%>% group_by(group, variable,value) %>% count() %>% tidyr::unite(Variante, variable,value,sep=":") %>% ggplot(aes(x=group, y= n,fill=factor(Variante)))+geom_bar(stat="identity", position = "dodge")
```

Summarise by group/global (mit Lemma und Wortart)
```{r}
V4Sum <- SortIpV4[,21:44]
# for (k in 1:ncol(V4Ma1Sum)) {
#   for (l in 1:nrow(V4Ma1Sum)) {
#     V4Ma1Sum[l,k] <- as.character(V4Ma1Sum[l,k])
#   }
#   
# }

#V4Sum <- fastDummies::dummy_columns(V4Sum, select_columns = "tag")
V4Sum <- fastDummies::dummy_columns(V4Sum, select_columns = "lemma")
V4Sum <- data.frame(lapply(V4Sum, as.character), stringsAsFactors=FALSE)
V4Sum[is.na(V4Sum)] <- 0
V4Sum <- V4Sum[,-c(22,23)]
for (k in 1: ncol(V4Sum)){
  #if(!(is.na(V4Ma1Sum[l,k]))){
  #for (l in 1:nrow(V4Ma1Sum)) {
    V4Sum[,k] <- as.numeric(V4Sum[,k])
  #}
  #}
}
#V4Ma1Sum <-  rename(V4Ma1Sum, tag=V4TagMerge.tag)
#V4Ma1Sum <- rename(V4Ma1Sum, group= as.factor.group.)
V4Sum %>%
  group_by(group)%>%
  summarise_all(sum)-> V4Summary
```
Zusammenfassungen
```{r}
V4SumMa1 <- SortIpV4Ma1[,21:44]
# for (k in 1:ncol(V4Ma1Sum)) {
#   for (l in 1:nrow(V4Ma1Sum)) {
#     V4Ma1Sum[l,k] <- as.character(V4Ma1Sum[l,k])
#   }
#   
# }

#V4SumMa1 <- fastDummies::dummy_columns(V4SumMa1, select_columns = "tag")
V4SumMa1 <- fastDummies::dummy_columns(V4SumMa1, select_columns = "lemma")
V4SumMa1 <- data.frame(lapply(V4SumMa1, as.character), stringsAsFactors=FALSE)
V4SumMa1[is.na(V4SumMa1)] <- 0
V4SumMa1 <- V4SumMa1[,-c(22,23)]
for (k in 1: ncol(V4SumMa1)){
  #if(!(is.na(V4Ma1Sum[l,k]))){
  #for (l in 1:nrow(V4Ma1Sum)) {
    V4SumMa1[,k] <- as.numeric(V4SumMa1[,k])
  #}
  #}
}
#V4Ma1Sum <-  rename(V4Ma1Sum, tag=V4TagMerge.tag)
#V4Ma1Sum <- rename(V4Ma1Sum, group= as.factor.group.)
V4SumMa1 %>%
  group_by(group)%>%
  summarise_all(sum)-> V4SummaryMa1

V4SumMa2 <- SortIpV4Ma2[,21:44]
# for (k in 1:ncol(V4Ma1Sum)) {
#   for (l in 1:nrow(V4Ma1Sum)) {
#     V4Ma1Sum[l,k] <- as.character(V4Ma1Sum[l,k])
#   }
#   
# }

V4SumMa2 <- fastDummies::dummy_columns(V4SumMa2, select_columns = "tag")
V4SumMa2 <- fastDummies::dummy_columns(V4SumMa2, select_columns = "lemma")
V4SumMa2 <- data.frame(lapply(V4SumMa2, as.character), stringsAsFactors=FALSE)
V4SumMa2[is.na(V4SumMa2)] <- 0
V4SumMa2 <- V4SumMa2[,-c(22,23)]
for (k in 1: ncol(V4SumMa2)){
  #if(!(is.na(V4Ma1Sum[l,k]))){
  #for (l in 1:nrow(V4Ma1Sum)) {
    V4SumMa2[,k] <- as.numeric(V4SumMa2[,k])
  #}
  #}
}
#V4Ma1Sum <-  rename(V4Ma1Sum, tag=V4TagMerge.tag)
#V4Ma1Sum <- rename(V4Ma1Sum, group= as.factor.group.)
V4SumMa2 %>%
  group_by(group)%>%
  summarise_all(sum)-> V4SummaryMa2

V4SumMa4 <- SortIpV4Ma4[,21:44]
# for (k in 1:ncol(V4Ma1Sum)) {
#   for (l in 1:nrow(V4Ma1Sum)) {
#     V4Ma1Sum[l,k] <- as.character(V4Ma1Sum[l,k])
#   }
#   
# }

V4SumMa4 <- fastDummies::dummy_columns(V4SumMa4, select_columns = "tag")
V4SumMa4 <- fastDummies::dummy_columns(V4SumMa4, select_columns = "lemma")
V4SumMa4 <- data.frame(lapply(V4SumMa4, as.character), stringsAsFactors=FALSE)
V4SumMa4[is.na(V4SumMa4)] <- 0
V4SumMa4 <- V4SumMa4[,-c(22,23)]
for (k in 1: ncol(V4SumMa4)){
  #if(!(is.na(V4Ma1Sum[l,k]))){
  #for (l in 1:nrow(V4Ma1Sum)) {
    V4SumMa4[,k] <- as.numeric(V4SumMa4[,k])
  #}
  #}
}
#V4Ma1Sum <-  rename(V4Ma1Sum, tag=V4TagMerge.tag)
#V4Ma1Sum <- rename(V4Ma1Sum, group= as.factor.group.)
V4SumMa4 %>%
  group_by(group)%>%
  summarise_all(sum)-> V4SummaryMa4
```
Barplots by groups MA1
```{r}
V4SumMa1 %>%  melt(id.vars= "group")%>% group_by(group, variable) %>% summarise(n= sum(value)) %>%slice(1:22) %>% filter(n!=0)%>% ggplot(aes(x=variable, y= n,fill=factor(group)))+geom_bar(stat="identity", position = "dodge")
```

Barplots by groups MA2
```{r}
V4SumMa2 %>%  melt(id.vars= "group")%>% group_by(group, variable) %>% summarise(n= sum(value)) %>%slice(1:22) %>% filter(n!=0)%>% ggplot(aes(x=variable, y= n,fill=factor(group)))+geom_bar(stat="identity", position = "dodge")
```

Barplots by groups MA4
```{r}
V4SumMa4 %>%  melt(id.vars= "group")%>% group_by(group, variable) %>% summarise(n= sum(value)) %>%slice(1:22) %>% filter(n!=0)%>% ggplot(aes(x=variable, y= n,fill=factor(group)))+geom_bar(stat="identity", position = "dodge")
```

