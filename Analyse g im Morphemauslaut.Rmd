---
title: "R Notebook"
output: html_notebook
---
Analyse VndsBand

Clusterverfahren in Funktion schreiben
```{r}
com_clust <- function(data,variables = c(1:ncol(data)),weight= 1){
adjmatrix <- 1- daisy(data[,variables], metric = c("gower"), weights = weight) # ungewichteter Vergleich, ausgenommen e0, e1, da nur ein auftreten überhaupt

x <- as.matrix(adjmatrix) #schreibt Aehnlichkeitsmatrix in ein R Objekt

g1 <- graph_from_adjacency_matrix(x, mode = c("lower"), weighted = TRUE, diag = FALSE, add.colnames = NULL, add.rownames = NA) #erstellt Graphfile aus unterer H??lfte der Aehnlichkeitsmatrix

cfg <- cluster_louvain(g1, weights = NULL) #sucht im Graphen nach Gruppen

#plot(cfg, g1, vertex.size=10, vertex.label.font=20, family="serif", edge.width=E(g1)$weight, sub= stringr::str_c("Modularity=",modularity(cfg))) #Zeichnet Graphen samt Gruppierungen

group <- as.factor(membership(cfg))
data <- cBind(data,group)

return(list(data,
plot(cfg, g1, vertex.size=10, vertex.label.font=20, family="serif", edge.width=E(g1)$weight, sub= stringr::str_c("Modularity=",modularity(cfg)))))
}
```

Install the ExmaraldaR Beta Package
```{r}

library(devtools)
```
```{r}
install_github("TimoSchuer/ExmaraldaR", force = TRUE)

```

load all required packages

```{r}
library(ExmaraldaR)
library(igraph)
library(Matrix)
library(cluster)
library(dplyr)
library(tm)
library(koRpus)
library(koRpus.lang.de)
library(purrr)
library(ggplot2)
library(FactoMineR)
library(ca)
library(rms)
library(MASS)
```



Read Korpus, set Path of required Directorys/ files, set Path of treetagger
```{r}
pathDir <- choose.dir()
pathTagSet <- choose.files()
PathTreeTag= "C:/TreeTagger/bin/tag-german.bat" 
set.kRp.env(TT.cmd= PathTreeTag, lang= "de")#Pfad des TreeTagges setzen
```
Read Korpus
Subsetting annotated events
```{r}
Corpus <- read_exb_dir(pathDir = pathDir, PathTagSet = pathTagSet, addMetaData = TRUE)
Corpus$Variable <- stringr::str_remove_all(Corpus$Variable,";")
Annotated <- filter(Corpus, !(is.na(Variable)))
```
Split up Variable and variant
```{r}
Annotated <- tidyr::separate(Annotated,col= "Variable", into=c("Variable","Variante"), sep=":")
```
Lemmatize annotated events
```{r}
stringr::str_remove_all(Annotated$Text, "\\W") %>% 
  stringr::str_to_lower() ->token
  PoSLemma <- treetag(token,debug=TRUE, format= "obj")
Annotated <- cbind(Annotated, PoSLemma[,2:3])

```
Corpus und Annotated als CSV speichern für Reproduktion
```{r}
write.csv(Corpus, file= "Corpus.csv", sep = ";")
write.csv(Annotated, file= "Annotated.csv", sep = ";")
```

Belege für g im Morphem- und Wortauslaut auswählen
```{r}
V5 <- filter(Annotated, Variable=="V05")
AnalyseV5 <- dplyr::select(V5, 3,6,19,24:27,31,32) 
for (k in 1:ncol(AnalyseV5)) {
  AnalyseV5[,k] <- as.factor(AnalyseV5[,k])
}
#Plot nach annotierten Kategorien
AnalyseV5 <- com_clust(AnalyseV5)
AnalyseV5 <- AnalyseV5[[1]]
```

```{r}
# Vars <- colnames(AnalyseV5)
# AnalyseV5 <- V5[,which(colSums(AnalyseV5)>0)]
Vars <- colnames(AnalyseV5)
f <- paste(Vars[10], "~", paste(Vars[-c(10,4)], collapse=" + "))
#corV5 <- cor(AnalyseV5[,-c(13,16:17,22:24,35,36)])
V5LDA <- lda(as.formula(paste(f)),data=AnalyseV5, prior=c(36,42,23,30)/131)
V5LDA
plot(V5LDA)
V5LDAScal <- as.data.frame(V5SumMa4LDA$scaling)
V5LDAScal[,3] <-V5LDAScal$LD1- V5LDAScal$LD2

```
Merge Tags by IP
```{r}
# Merge Tags
V5TagMerge <- V5
remove(k)
V5TagMerge$tag <-as.character(V5TagMerge$tag)
V5TagMerge$lemma <- as.character(V5TagMerge$lemma)
for (k in nrow(V5TagMerge):2) {
  if((V5TagMerge[k,1]==V5TagMerge[k-1,1])){
    if(V5TagMerge$tag[k] != V5TagMerge$tag[k-1]){
    V5TagMerge$tag[k-1] <- stringr::str_c(V5TagMerge$tag[k-1],V5TagMerge$tag[k], sep = ":")
    V5TagMerge$lemma[k-1] <- stringr::str_c(V5TagMerge$lemma[k-1],V5TagMerge$lemma[k], sep = ":")
    
    }
    V5TagMerge <- V5TagMerge[-k,]
  }else{
    next()
  }
  
}
V5TagMerge$tag <-as.factor(V5TagMerge$tag)
V5TagMerge$lemma <-as.factor(V5TagMerge$lemma)
#V5IpTag <- cbind(SortIpV5,V5TagMerge$tag,V5TagMerge$lemma)
```
Plot Kookkurrenz über Situationen hinweg
```{r}
SortIpNA <- sort_by_unit(exb=Corpus, drop = TRUE)
SortIpNaAbsolute <- sort_by_unit(Corpus, drop=TRUE, percentage=FALSE)
SortIpV5 <- filter(SortIpNA, SortIpNA$`Variable:V05:gg`!=0|SortIpNA$`Variable:V05:ch`!=0)
SortIpV5 <- bind_cols(SortIpV5, V5TagMerge[,31:32])
#SortIpOHNEMA3 <- filter(SortIpV5,File != " Ma3" )
#SortIpV4 <- select(SortIpV4, 1,16:40)
for (p in 1:ncol(SortIpNA)) {
  SortIpNA[,p] <- as.factor(SortIpNA[,p])
}
SortIpV5 <- com_clust(SortIpV5, variables = c(16:38))
SortIpV5 <- SortIpV5[[1]]
```
LDA coocurrence Global

```{r}
# Vars <- colnames(AnalyseV5)
# AnalyseV5 <- V5[,which(colSums(AnalyseV5)>0)]
SortIpV5[is.na(SortIpV5)] <- 0 #NA durch 0 ersetzen
#Vars <- colnames(SortIpV5)
#f <- paste(Vars[39], "~", paste(Vars[-c(1:2,5:15,39)], collapse=" + "))
#corV5 <- cor(AnalyseV5[,-c(13,16:17,22:24,35,36)])
#V5LDA <- lda(as.formula(paste(f)),data=SortIpV5, prior=c(36,42,23,30)/131)
V5GlobLDA <- lda( SortIpV5[,-c(1:15,32,39)],SortIpV5$group, prior = c(41,73,15)/129)
V5GlobLDA$lev <- as.integer(V5GlobLDA$lev)
plot(V5GlobLDA)
V5LDAScal <- as.data.frame(V5SumMa4LDA$scaling)
V5LDAScal[,3] <-V5LDAScal$LD1- V5LDAScal$LD2
```

Cooccurrence Plot by Situation
```{r}
#SortIpNA <- sort_by_unit(exb=Corpus, drop = TRUE)

files <- unique(SortIpV5$File)
for (k in 1:length(files)) {
  g <- filter(SortIpV5, SortIpV5$File==files[k])
    for (p in 1:ncol(g)) {
      g[,p] <- as.factor(g[,p])
    }
  name <- stringr::str_glue("SortIpV5",stringr::str_trim(files[k]))
  assign(name,g)
}
SortIpV5Ma1 <- com_clust(SortIpV5Ma1,variables = c(16:38))
SortIpV5Ma1 <- SortIpV5Ma1[[1]]
SortIpV5Ma2 <- com_clust(SortIpV5Ma2,variables = c(16:38))
SortIpV5Ma2 <- SortIpV5Ma2[[1]]
SortIpV5Ma4 <- com_clust(SortIpV5Ma4,variables = c(16:38))
SortIpV5Ma4 <- SortIpV5Ma4[[1]]
```
Summarise by group/global
```{r}
V5Sum <- SortIpV5[,16:39]
# for (k in 1:ncol(V5Ma1Sum)) {
#   for (l in 1:nrow(V5Ma1Sum)) {
#     V5Ma1Sum[l,k] <- as.character(V5Ma1Sum[l,k])
#   }
#   
# }

V5Sum <- fastDummies::dummy_columns(V5Sum, select_columns = "tag")
V5Sum <- fastDummies::dummy_columns(V5Sum, select_columns = "lemma")
V5Sum <- data.frame(lapply(V5Sum, as.character), stringsAsFactors=FALSE)
V5Sum[is.na(V5Sum)] <- 0
for (k in 1: ncol(V5Sum)){
  #if(!(is.na(V5Ma1Sum[l,k]))){
  #for (l in 1:nrow(V5Ma1Sum)) {
    V5Sum[,k] <- as.numeric(V5Sum[,k])
  #}
  #}
}
#V5Ma1Sum <-  rename(V5Ma1Sum, tag=V5TagMerge.tag)
#V5Ma1Sum <- rename(V5Ma1Sum, group= as.factor.group.)
V5Sum[,-c(22,23)] %>%
  group_by(group)%>%
  summarise_all(sum)-> V5Summary
```

```{r}
cor <- cor(V5Summary[,-c(1)])
V5PCA <- PCA(V5Summary[,-1], quali.sup = 1)
dimdesc(V5PCA, axes = 1:2)
plot(V5PCA)
V5Ma1PCA$ind

#PCA(V5Summary[,-c(1)], quali.sup = 1)
```
discriminant analysis global
```{r}
#V5Sum <- rename(V5Sum, group= as.factor.group.)
Vars <- colnames(V5Sum)
f <- paste(Vars[24], "~", paste(Vars[-c(13,22:24,16:17,35:36)], collapse=" + "))
corV5Sum <- cor(V5Sum[,-c(13,16:17,22:24,35,36)])
V5SumLDA <- lda(as.formula(paste(f)),data=V5Sum, prior=c(41,73,15)/129)
V5SumLDA
plot(V5SumLDA)
```
Summarise by group/situation
```{r}
V5SumMa1 <- SortIpV5Ma1[,16:39]
# for (k in 1:ncol(V5Ma1Sum)) {
#   for (l in 1:nrow(V5Ma1Sum)) {
#     V5Ma1Sum[l,k] <- as.character(V5Ma1Sum[l,k])
#   }
#   
# }

V5SumMa1 <- fastDummies::dummy_columns(V5SumMa1, select_columns = "tag")
V5SumMa1 <- fastDummies::dummy_columns(V5SumMa1, select_columns = "lemma")
V5SumMa1 <- data.frame(lapply(V5SumMa1, as.character), stringsAsFactors=FALSE)
V5SumMa1[is.na(V5SumMa1)] <- 0
for (k in 1: ncol(V5SumMa1)){
  #if(!(is.na(V5Ma1Sum[l,k]))){
  #for (l in 1:nrow(V5Ma1Sum)) {
    V5SumMa1[,k] <- as.numeric(V5SumMa1[,k])
  #}
  #}
}
#V5Ma1Sum <-  rename(V5Ma1Sum, tag=V5TagMerge.tag)
#V5Ma1Sum <- rename(V5Ma1Sum, group= as.factor.group.)
V5SumMa1[,-c(22,23)] %>%
  group_by(group)%>%
  summarise_all(sum)-> V5SummaryMa1

V5SumMa2 <- SortIpV5Ma2[,16:39]
# for (k in 1:ncol(V5Ma1Sum)) {
#   for (l in 1:nrow(V5Ma1Sum)) {
#     V5Ma1Sum[l,k] <- as.character(V5Ma1Sum[l,k])
#   }
#   
# }

V5SumMa2 <- fastDummies::dummy_columns(V5SumMa2, select_columns = "tag")
V5SumMa2 <- fastDummies::dummy_columns(V5SumMa2, select_columns = "lemma")
V5SumMa2 <- data.frame(lapply(V5SumMa2, as.character), stringsAsFactors=FALSE)
V5SumMa2[is.na(V5SumMa2)] <- 0
for (k in 1: ncol(V5SumMa2)){
  #if(!(is.na(V5Ma1Sum[l,k]))){
  #for (l in 1:nrow(V5Ma1Sum)) {
    V5SumMa2[,k] <- as.numeric(V5SumMa2[,k])
  #}
  #}
}
#V5Ma1Sum <-  rename(V5Ma1Sum, tag=V5TagMerge.tag)
#V5Ma1Sum <- rename(V5Ma1Sum, group= as.factor.group.)
V5SumMa2[,-c(22,23)] %>%
  group_by(group)%>%
  summarise_all(sum)-> V5SummaryMa2

V5SumMa4 <- SortIpV5Ma4[,16:39]
# for (k in 1:ncol(V5Ma1Sum)) {
#   for (l in 1:nrow(V5Ma1Sum)) {
#     V5Ma1Sum[l,k] <- as.character(V5Ma1Sum[l,k])
#   }
#   
# }

V5SumMa4 <- fastDummies::dummy_columns(V5SumMa4, select_columns = "tag")
V5SumMa4 <- fastDummies::dummy_columns(V5SumMa4, select_columns = "lemma")
V5SumMa4 <- data.frame(lapply(V5SumMa4, as.character), stringsAsFactors=FALSE)
V5SumMa4[is.na(V5SumMa4)] <- 0
for (k in 1: ncol(V5SumMa4)){
  #if(!(is.na(V5Ma1Sum[l,k]))){
  #for (l in 1:nrow(V5Ma1Sum)) {
    V5SumMa4[,k] <- as.numeric(V5SumMa4[,k])
  #}
  #}
}
#V5Ma1Sum <-  rename(V5Ma1Sum, tag=V5TagMerge.tag)
#V5Ma1Sum <- rename(V5Ma1Sum, group= as.factor.group.)
V5SumMa4[,-c(22,23)] %>%
  group_by(group)%>%
  summarise_all(sum)-> V5SummaryMa4
```
LDA group/Situation
```{r}
#V5SumMa1 <- rename(V5SumMa1, group= as.factor.group.)
V5SumMa1 <- mutate_if(V5SumMa1, is.double, as.integer)
#V5SumMa2 <- rename(V5SumMa4, group= as.factor.group.)
V5SumMa2 <- mutate_if(V5SumMa2, is.double, as.integer)
#V5SumMa4 <- rename(V5SumMa4, group= as.factor.group.)
V5SumMa4 <- mutate_if(V5SumMa4, is.double, as.integer)
```
```{r}
V5SumMa1 <- V5SumMa1[,which(colSums(V5SumMa1)>0)]
Vars <- colnames(V5SumMa1)
f <- paste(Vars[15], "~", paste(Vars[-c(15)], collapse=" + "))
corV5SumMa1 <- cor(V5SumMa1[,-c(16:18)])
V5SumMa1LDA <- lda(as.formula(paste(f)),data=V5SumMa1, prior=c(26,15,13)/54)
V5SumMa1LDA
plot(V5SumMa1LDA)
V5SumMa1LDAScal <- as.data.frame(V5SumMa1LDA$scaling)
V5SumMa1LDAScal[,3] <-V5SumMa1LDAScal$LD1- V5SumMa1LDAScal$LD2
```

```{r}
V5SumMa2 <- V5SumMa2[,which(colSums(V5SumMa2)>0)]
Vars <- colnames(V5SumMa2)
f <- paste(Vars[16], "~", paste(Vars[-c(16)], collapse=" + "))
corV5SumMa2 <- cor(V5SumMa2[,-14])
V5SumMa2LDA <- lda(as.formula(paste(f)),data=V5SumMa2, prior=c(17,21,3)/41)
V5SumMa2LDA
plot(V5SumMa2LDA)
V5SumMa2LDAScal <- as.data.frame(V5SumMa2LDA$scaling)
V5SumMa2LDAScal[,3] <-V5SumMa2LDAScal$LD1- V5SumMa2LDAScal$LD2
```

```{r}
V5SumMa4 <- V5SumMa4[,which(colSums(V5SumMa4)>0)]
Vars <- colnames(V5SumMa4)
f <- paste(Vars[14], "~", paste(Vars[-14], collapse=" + "))
corV5SumMa4 <- cor(V5SumMa4[,-c(13,16:17,22:24,35,36)])
V5SumMa4LDA <- lda(as.formula(paste(f)),data=V5SumMa4, prior=c(9,25)/34)
V5SumMa4LDA
plot(V5SumMa4LDA)
V5SumMa4LDAScal <- as.data.frame(V5SumMa4LDA$scaling)
V5SumMa4LDAScal[,3] <-V5SumMa4LDAScal$LD1- V5SumMa4LDAScal$LD2
```
































































































Lemma als Kategorie

```{r}
dummiesLemma <- as.data.frame(dummies::dummy("lemma",V5, sep=":")) #create binary values of variable
dummiesTAG <- as.data.frame(dummies::dummy("tag",V5, sep=":"))
dummiesLemma <- cbind(dummiesLemma,dummiesTAG)
#dummiesLEMMA<- as.data.frame(dummies::dummy("lemma",Corpus, sep=":")) #create binary values of variable
for (i in nrow(V5):2) {
  if(V5[i,1]==V5[i-1,1] & V5[i,"EventNumber"]!= V5[i-1,"EventNumber"]){
    dummiesLemma[i-1,] <- dummiesLemma[i-1,]+dummiesLemma[i,] # add up variable values
    dummiesLemma <- dummiesLemma[-i, ]
  }else if(V5[i,1]==V5[i-1,1] & V5[i,"EventNumber"]==V5[i-1,"EventNumber"]){
    dummiesLemma[i-1,] <- dummiesLemma[i-1,]+dummiesLemma[i,] # add up variable values
    dummiesLemma <- dummiesLemma[-i, ]
  }
}
#in Prozent umrechnen
    Sums <- unname(rowSums(dummiesLemma)) # get RowSums
          for (n in 1:nrow(dummiesLemma)){
        if(Sums[n] !=0){
          for (l in 1:ncol(dummiesLemma)){
            dummiesLemma[n,l] <- as.numeric(dummiesLemma[n,l])
            dummiesLemma[n,l] <- dummiesLemma[n,l]/Sums[n] # get percentage
          }
        }
          }
V5IpTag <- bind_cols(SortIpV5,dummiesLemma)
```

Plot by situation with Cooccurrence and Tag
```{r}
files <- unique(V5IpTag$File)
for (k in 1:length(files)) {
  g <- filter(V5IpTag, V5IpTag$File==files[k])
    for (p in 1:ncol(g)) {
      g[,p] <- as.factor(g[,p])
    }
  name <- stringr::str_glue("V5IpTag",stringr::str_trim(files[k]))
  assign(name,g)
}
#Gewichtung aller Variablen und der Wortart gleich um Variantenreichtum rauszurechnen
#c(0.055,0.055,0.055,0.055,0.055,0.055,0.055,0.055,0.055,0.055,0.055,0.055,0.277,0.277,0.277,0.277,0.055,0.055,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012,0.012)
#Ma1
com_clust(V5IpTagMa1)
com_clust(V5IpTagMa2)
com_clust(V5IpTagMa4)
```
find best combination
```{r}
#find variables without variation
V5IpTagNum <- V5IpTag
for (k in 1:ncol(V5IpTag)) {
  V5IpTagNum[,k] <- as.numeric(V5IpTagNum[,k])
}
V5IpTagOhneNull <- select_if(V5IpTagNum, sum()!=0)

V5IpTagOhneNull <- V5IpTagNum[,-(which(colSums(V5IpTagNum)==0))]
colsum <- colSums(V5IpTagNum, na.rm = TRUE)
find_comb <- function(data, variables){
  
}
```
